# ğŸ” rust-analyzer ã‚³ãƒ¼ãƒ‰è§£æ

ã“ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«**ã©ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚Œã°ã„ã„ã‹**ã€**ã©ã‚“ãªä»•çµ„ã¿ã‚’ä½¿ãˆã°ã„ã„ã‹**ã‚’åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¾ã™ã€‚

## ğŸ—º å…¨ä½“ãƒãƒƒãƒ—ï¼šã©ã“ã«ä½•ãŒã‚ã‚‹ã‹

```
ğŸ  rust-analyzer (å·¨å¤§ãªå®¶)
â”œâ”€â”€ ğŸ¢ crates/ide-assists/     ğŸ‘ˆ æˆ‘ã€…ã®ä½œæ¥­å ´æ‰€
â”‚   â”œâ”€â”€ ğŸ“ src/handlers/       ğŸ‘ˆ ã“ã“ã«æ–°æ©Ÿèƒ½ã‚’è¿½åŠ 
â”‚   â”‚   â”œâ”€â”€ ğŸ“„ auto_import.rs  ğŸ‘ˆ useæ–‡ã®å…ˆè¼©æ©Ÿèƒ½ (å‚è€ƒã«ãªã‚‹!)
â”‚   â”‚   â””â”€â”€ ğŸ“„ move_use_to_top.rs ğŸ‘ˆ ã“ã‚Œã‚’æ–°ã—ãä½œã‚‹
â”‚   â””â”€â”€ ğŸ“„ src/lib.rs         ğŸ‘ˆ æ–°æ©Ÿèƒ½ã‚’ç™»éŒ²ã™ã‚‹å ´æ‰€
â””â”€â”€ ğŸ­ crates/ide-db/         ğŸ‘ˆ ä¾¿åˆ©ãªé“å…·ç®±
    â””â”€â”€ ğŸ“ src/imports/        ğŸ‘ˆ useæ–‡æ“ä½œã®é­”æ³•ãŒè©°ã¾ã£ã¦ã‚‹
```

## ğŸ“ Assists ã®åŸºæœ¬æ§‹é€ 

### ğŸ— ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
```
rust-analyzer/
â”œâ”€â”€ crates/
â”‚   â”œâ”€â”€ ide-assists/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ handlers/         ğŸ‘ˆ ã‚¢ã‚·ã‚¹ãƒˆå®Ÿè£…ã®å ´æ‰€
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auto_import.rs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ extract_module.rs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ move_use_to_top.rs  ğŸ‘ˆ æ–°ã—ãä½œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”‚   â”‚   â”œâ”€â”€ utils.rs          ğŸ‘ˆ å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”‚   â””â”€â”€ lib.rs            ğŸ‘ˆ ã‚¢ã‚·ã‚¹ãƒˆç™»éŒ²
â”‚   â”‚   â””â”€â”€ ide-db/
â”‚   â”‚       â””â”€â”€ src/imports/      ğŸ‘ˆ importæ“ä½œã®æ ¸å¿ƒéƒ¨åˆ†
```

## ğŸ§© ã‚¢ã‚·ã‚¹ãƒˆã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³è©³ç´°è§£èª¬

### ğŸ“š å‰æçŸ¥è­˜ï¼šåŸºç¤æ¦‚å¿µã®å®šç¾©

#### ğŸŒ³ ASTï¼ˆæŠ½è±¡æ§‹æ–‡æœ¨ï¼‰ã¨ã¯
**ASTï¼ˆAbstract Syntax Treeï¼‰** = Rustã‚³ãƒ¼ãƒ‰ã‚’æœ¨æ§‹é€ ã§è¡¨ç¾ã—ãŸã‚‚ã®

```
Rustã‚³ãƒ¼ãƒ‰                     ASTï¼ˆæœ¨æ§‹é€ ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fn test() {           â†’        FN
    let x = 1;        â†’        â”œâ”€â”€ BLOCK  
}                              â”‚   â””â”€â”€ LET_STMT
                               â”‚       â””â”€â”€ LITERAL(1)
```

#### ğŸ§± ãƒãƒ¼ãƒ‰ï¼ˆNodeï¼‰ã¨ã¯
**ãƒãƒ¼ãƒ‰** = ASTå†…ã®1ã¤ã®è¦ç´ ã€‚ã€Œé–¢æ•°ã€ã€Œå¤‰æ•°ã€ã€Œæ–‡ã€ãªã©ã‚’è¡¨ã™

```
å„ãƒãƒ¼ãƒ‰ã®ä¾‹ï¼š
- ast::Fn     = é–¢æ•°ãƒãƒ¼ãƒ‰      fn test() { ... }
- ast::Use    = useæ–‡ãƒãƒ¼ãƒ‰     use std::fmt;  
- ast::Let    = letæ–‡ãƒãƒ¼ãƒ‰     let x = 1;
```

#### ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ è¦ªå­é–¢ä¿‚ã¨ã¯
**è¦ªå­é–¢ä¿‚** = ãƒãƒ¼ãƒ‰åŒå£«ã®éšå±¤é–¢ä¿‚

```
è¦ªãƒãƒ¼ãƒ‰ï¼šé–¢æ•°         fn test() {
å­ãƒãƒ¼ãƒ‰ï¼šuseæ–‡            use std::fmt;    â† é–¢æ•°ã®ä¸­ã«ã‚ã‚‹
å­ãƒãƒ¼ãƒ‰ï¼šletæ–‡            let x = 1;       â† é–¢æ•°ã®ä¸­ã«ã‚ã‚‹
                      }
```

#### ğŸ¯ castï¼ˆã‚­ãƒ£ã‚¹ãƒˆï¼‰ã¨ã¯
**cast** = ã€Œæ±ç”¨ãƒãƒ¼ãƒ‰ã€ã‚’ã€Œç‰¹å®šã®å‹ã®ãƒãƒ¼ãƒ‰ã€ã«å¤‰æ›ã™ã‚‹ã“ã¨

```
SyntaxNodeï¼ˆæ±ç”¨ï¼‰  â†’  ast::Fnï¼ˆé–¢æ•°å°‚ç”¨ï¼‰
   â†“ cast
ã€Œä½•ã‹ã®ãƒãƒ¼ãƒ‰ã€    â†’  ã€Œé–¢æ•°ãƒãƒ¼ãƒ‰ã ã¨ç¢ºèªæ¸ˆã¿ã€
```

#### ğŸ” ancestors()ã¨ã¯
**ancestors** = ã€Œç¥–å…ˆã€ã¨ã„ã†æ„å‘³ã€‚è‡ªåˆ†ã®è¦ªã€è¦ªã®è¦ªã€...ã‚’é †ç•ªã«è¿”ã™ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿

```
fn test() {           â† 3ç•ªç›®: Fnãƒãƒ¼ãƒ‰ï¼ˆé–¢æ•°ï¼‰
    {                 â† 2ç•ªç›®: Blockãƒãƒ¼ãƒ‰ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ï¼‰
        use std::fmt; â† 1ç•ªç›®: Useãƒãƒ¼ãƒ‰ï¼ˆè‡ªåˆ†ï¼‰
    }
}
```

#### ğŸ¯ find_map()ã¨ã¯
**find_map**: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã®å„è¦ç´ ã«é–¢æ•°ã‚’é©ç”¨ã—ã¦ã€æœ€åˆã«æˆåŠŸã—ãŸã‚‚ã®ã‚’è¿”ã™

```
å‹•ä½œã®æµã‚Œï¼š
1. Useãƒãƒ¼ãƒ‰ â†’ ast::Fn::cast â†’ Noneï¼ˆé–¢æ•°ã˜ã‚ƒãªã„ï¼‰
2. Blockãƒãƒ¼ãƒ‰ â†’ ast::Fn::cast â†’ Noneï¼ˆé–¢æ•°ã˜ã‚ƒãªã„ï¼‰  
3. Fnãƒãƒ¼ãƒ‰ â†’ ast::Fn::cast â†’ Some(ast::Fn)ï¼ˆæˆåŠŸï¼ï¼‰
```

### ğŸ”§ Assists ã¨ã¯ä½•ã‹ï¼Ÿ
`Assists` ã¯ rust-analyzer ã«ãŠã‘ã‚‹ã‚³ãƒ¼ãƒ‰å¤‰æ›æ©Ÿèƒ½ã®**ã‚³ãƒ³ãƒ†ãƒŠ**ã§ã™ã€‚ã‚¨ãƒ‡ã‚£ã‚¿ãŒã€Œä½•ãŒã§ãã‚‹ã‹ã€ã‚’çŸ¥ã‚‹ãŸã‚ã®**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§**ã‚’ç®¡ç†ã—ã¾ã™ã€‚

```
ğŸ¬ å®Ÿè¡Œã®æµã‚Œ
ã‚¨ãƒ‡ã‚£ã‚¿ã€Œä½•ãŒã§ãã‚‹ï¼Ÿã€ 
    â†“
rust-analyzerã€ŒAssistsã‚’ç¢ºèªä¸­...ã€
    â†“  
å„ã‚¢ã‚·ã‚¹ãƒˆé–¢æ•°ã€Œç§ãŒã§ãã‚‹ï¼ã€â†’ acc.add()
    â†“
ã‚¨ãƒ‡ã‚£ã‚¿ã€Œã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€
```

### ğŸ§­ AssistContext ã¨ã¯ä½•ã‹ï¼Ÿ
`AssistContext` ã¯**ã‚³ãƒ¼ãƒ‰åˆ†æã®é“å…·ç®±**ã§ã™ã€‚ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã€é¸æŠç¯„å›²ã€ASTãƒãƒ¼ãƒ‰ãªã©ã€ã‚¢ã‚·ã‚¹ãƒˆãŒåˆ¤æ–­ã«å¿…è¦ãªå…¨æƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚

```
ğŸ“‹ AssistContext ã®ä¸­èº«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®æƒ…å ±          â”‚
â”‚ ğŸ“ é¸æŠç¯„å›²                 â”‚  
â”‚ ğŸŒ³ æ§‹æ–‡æœ¨ï¼ˆASTï¼‰ã¸ã®å‚ç…§      â”‚
â”‚ ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±             â”‚
â”‚ âš™ï¸  è¨­å®šæƒ…å ±                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ—ï¸ ã‚¢ã‚·ã‚¹ãƒˆå®Ÿè£…ã®åŸºæœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```rust
pub(crate) fn move_use_to_top(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {
    // 1ï¸âƒ£ é©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯ - ã€Œã“ã®ã‚¢ã‚·ã‚¹ãƒˆãŒä½¿ãˆã‚‹ã‹ï¼Ÿã€
    let use_item = ctx.find_node_at_offset::<ast::Use>()?;
    
    // 2ï¸âƒ£ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ - ã€Œã©ã‚“ãªçŠ¶æ³ã‹ï¼Ÿã€
    // useæ–‡ã‹ã‚‰ä¸Šã«å‘ã‹ã£ã¦è¦ªè¦ç´ ã‚’è¾¿ã‚Šã€æœ€åˆã«è¦‹ã¤ã‹ã£ãŸé–¢æ•°ãƒãƒ¼ãƒ‰ã‚’å–å¾—
    let parent_fn = use_item.syntax().ancestors()
        .find_map(ast::Fn::cast)?;
    
    // 3ï¸âƒ£ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™»éŒ² - ã€Œã“ã‚“ãªå¤‰æ›ãŒã§ãã¾ã™ï¼ã€
    acc.add(
        AssistId("move_use_to_top", AssistKind::Refactor),
        "Move use statement to top-level",
        use_item.syntax().text_range(),
        |builder| {
            // 4ï¸âƒ£ å®Ÿéš›ã®å¤‰æ›å‡¦ç† - ã€Œå®Ÿè¡Œã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€
        },
    )
}
```

### ğŸ¯ ã‚¢ã‚·ã‚¹ãƒˆã®4æ®µéšè©³ç´°

#### 1ï¸âƒ£ é©ç”¨å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯æ®µéš
```
ğŸ” è³ªå•ï¼šã€Œã“ã®ã‚¢ã‚·ã‚¹ãƒˆã¯ä»Šä½¿ãˆã‚‹ï¼Ÿã€

â”Œâ”€ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãƒã‚§ãƒƒã‚¯ â”€â”
â”‚ useæ–‡ã®ä¸Šã«ã‚ã‚‹ï¼Ÿ      â”‚ â†’ Yes: ç¶šè¡Œ / No: Noneè¿”å´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2ï¸âƒ£ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†ææ®µéš  
```
ğŸ§ è³ªå•ï¼šã€Œã©ã‚“ãªçŠ¶æ³ã§ä½•ã‚’ã™ã¹ãï¼Ÿã€

â”Œâ”€ çŠ¶æ³åˆ†æ â”€â”
â”‚ é–¢æ•°å†…ï¼Ÿ    â”‚ â†’ ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã¸ç§»å‹•ãŒå¿…è¦
â”‚ implå†…ï¼Ÿ    â”‚ â†’ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒˆãƒƒãƒ—ã¸ç§»å‹•
â”‚ æ—¢ã«ãƒˆãƒƒãƒ—ï¼Ÿ â”‚ â†’ ä½•ã‚‚ã—ãªã„ï¼ˆé©ç”¨ä¸å¯ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3ï¸âƒ£ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™»éŒ²æ®µéš
```
ğŸ“ è³ªå•ï¼šã€Œã‚¨ãƒ‡ã‚£ã‚¿ã«ä½•ã‚’è¡¨ç¤ºã™ã‚‹ï¼Ÿã€

AssistId: move_use_to_top        // å†…éƒ¨è­˜åˆ¥å­
AssistKind: Refactor            // ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
Label: "Move use to top"        // ã‚¨ãƒ‡ã‚£ã‚¿ã«è¡¨ç¤ºã•ã‚Œã‚‹æ–‡è¨€
Target: useæ–‡ã®ç¯„å›²             // ãƒã‚¤ãƒ©ã‚¤ãƒˆç¯„å›²
```

#### 4ï¸âƒ£ å®Ÿè¡Œæ®µéšï¼ˆbuilderå†…ï¼‰
```
âš¡ è³ªå•ï¼šã€Œå®Ÿéš›ã«ã©ã†å¤‰æ›ã™ã‚‹ï¼Ÿã€

builder.delete(å…ƒã®useæ–‡ã®ä½ç½®)
builder.insert(ãƒˆãƒƒãƒ—ã®ä½ç½®, æ–°ã—ã„useæ–‡)
```

### ğŸ›ï¸ ã‚¢ã‚·ã‚¹ãƒˆå®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
ğŸ® ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆVSCodeç­‰ï¼‰
    â†“ ã€Œã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã§ã§ãã‚‹ã“ã¨ã¯ï¼Ÿã€
    
ğŸ§  rust-analyzer ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³
    â†“ å…¨ã‚¢ã‚·ã‚¹ãƒˆé–¢æ•°ã‚’å®Ÿè¡Œ
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ å„ã‚¢ã‚·ã‚¹ãƒˆé–¢æ•°                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ move_use_to_top(acc, ctx)   â”‚ â”‚
â”‚ â”‚ â”Œâ”€ 1ï¸âƒ£ãƒã‚§ãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚ â”‚ ctx.find_node_at_offset â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ "useæ–‡ã‚ã‚‹ï¼Ÿ"           â”‚   â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜   â”‚ â”‚
â”‚ â”‚ â”Œâ”€ 2ï¸âƒ£åˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚  
â”‚ â”‚ â”‚ "é–¢æ•°å†…ï¼Ÿãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼Ÿ" â”‚   â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜   â”‚ â”‚
â”‚ â”‚ â”Œâ”€ 3ï¸âƒ£ç™»éŒ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚ â”‚ acc.add(...)           â”‚   â”‚ â”‚ 
â”‚ â”‚ â”‚ "ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½ï¼"   â”‚   â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ Assistsã‚³ãƒ³ãƒ†ãƒŠã«è“„ç©
    
ğŸ“‹ çµæœï¼šåˆ©ç”¨å¯èƒ½ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§
    â†“ ã‚¨ãƒ‡ã‚£ã‚¿ã«è¿”å´
    
ğŸ® ã‚¨ãƒ‡ã‚£ã‚¿ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠè‚¢ã‚’è¡¨ç¤º
```

## ğŸ¯ é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¨æ©Ÿèƒ½

### ğŸ“„ `/crates/ide-assists/src/handlers/auto_import.rs`
**ãªãœé‡è¦**: useæ–‡ã®æŒ¿å…¥ã¨ãƒãƒ¼ã‚¸å‡¦ç†ã®ãŠæ‰‹æœ¬
```rust
// ğŸ”§ ä½¿ãˆã‚‹æ©Ÿèƒ½
use ide_db::imports::{
    insert_use::insert_use,          // useæ–‡ã®æŒ¿å…¥
    merge_imports::try_merge_imports, // useæ–‡ã®ãƒãƒ¼ã‚¸
    MergeBehavior,                   // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–æˆ¦ç•¥
};
```

### ğŸ“„ `/crates/ide-db/src/imports/`
**ãªãœé‡è¦**: importæ“ä½œã®æ ¸å¿ƒæ©Ÿèƒ½ãŒé›†ç´„ã•ã‚Œã¦ã„ã‚‹
```
imports/
â”œâ”€â”€ insert_use.rs     ğŸ‘ˆ useæ–‡æŒ¿å…¥ã®å‡¦ç†
â”œâ”€â”€ merge_imports.rs  ğŸ‘ˆ useæ–‡ã®ãƒãƒ¼ã‚¸å‡¦ç†  
â””â”€â”€ mod.rs           ğŸ‘ˆ importè¨­å®šã®å®šç¾©
```

## ğŸ® ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®æ¤œå‡º

## ğŸ§­ AssistContext ã®è©³ç´°è§£èª¬

### AssistContext ã®å½¹å‰²
`AssistContext` ã¯**ã‚¢ã‚·ã‚¹ãƒˆãŒåˆ¤æ–­ã«å¿…è¦ãªå…¨ã¦ã®æƒ…å ±**ã‚’é›†ç´„ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã§ã™ã€‚ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã€é¸æŠç¯„å›²ã€æ§‹æ–‡æœ¨ã€è¨­å®šãªã©ã€ã€Œä»Šã©ã‚“ãªçŠ¶æ³ã‹ï¼Ÿã€ã‚’çŸ¥ã‚‹ãŸã‚ã®æƒ…å ±æºã§ã™ã€‚

### ğŸ—ï¸ AssistContext ã®å†…éƒ¨æ§‹é€ 

```
ğŸ§­ AssistContext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ Position Information            â”‚
â”‚ â”œâ”€ offset: TextSize                â”‚ â† ã‚«ãƒ¼ã‚½ãƒ«ã®ä½ç½®ï¼ˆæ–‡å­—æ•°ï¼‰
â”‚ â”œâ”€ selection: TextRange            â”‚ â† é¸æŠç¯„å›²
â”‚ â””â”€ frange: FileRange               â”‚ â† ãƒ•ã‚¡ã‚¤ãƒ«+ç¯„å›²
â”‚                                     â”‚
â”‚ ğŸŒ³ Syntax Tree Access             â”‚  
â”‚ â”œâ”€ source_file: SourceFile         â”‚ â† æ§‹æ–‡æœ¨ã®ãƒ«ãƒ¼ãƒˆ
â”‚ â”œâ”€ db: &RootDatabase              â”‚ â† è§£æãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚ â””â”€ semantic: Semantic              â”‚ â† æ„å‘³è§£ææƒ…å ±
â”‚                                     â”‚
â”‚ âš™ï¸ Configuration                   â”‚
â”‚ â”œâ”€ config: &AssistConfig          â”‚ â† ã‚¢ã‚·ã‚¹ãƒˆã®è¨­å®š
â”‚ â””â”€ import_assets: ImportAssets     â”‚ â† importé–¢é€£è¨­å®š
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ AssistContext ã®ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰

#### ä½ç½®æ¤œå‡ºãƒ¡ã‚½ãƒƒãƒ‰
```rust
impl AssistContext {
    // ğŸ¯ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®ç‰¹å®šã®å‹ã®ASTãƒãƒ¼ãƒ‰ã‚’å–å¾—
    fn find_node_at_offset<N: AstNode>(&self) -> Option<N> {
        // ä¾‹: useæ–‡ã€é–¢æ•°ã€implæ–‡ãªã©ã‚’å–å¾—
        self.source_file
            .syntax()
            .token_at_offset(self.offset)
            .find_map(|token| token.parent_ancestors().find_map(N::cast))
    }
    
    // ğŸ“ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’è¦†ã†è¦ç´ ï¼ˆãƒãƒ¼ãƒ‰ã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
    fn covering_element(&self) -> SyntaxElement {
        // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®æœ€å°è¦ç´ ã‚’å–å¾—
    }
    
    // ğŸŒ é¸æŠç¯„å›²å†…ã®ç‰¹å®šå‹ãƒãƒ¼ãƒ‰ã‚’å–å¾—  
    fn find_node_in_selection<N: AstNode>(&self) -> Option<N>
    
    // âœ… é¸æŠç¯„å›²ãŒç©ºã‹ã©ã†ã‹
    fn has_empty_selection(&self) -> bool {
        self.selection.is_empty()
    }
}
```

#### æ§‹æ–‡è§£æãƒ¡ã‚½ãƒƒãƒ‰
```rust
impl AssistContext {
    // ğŸŒ³ æ§‹æ–‡æœ¨ã®ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
    fn source_file(&self) -> &SourceFile
    
    // ğŸ” æ„å‘³è§£æï¼ˆå‹æƒ…å ±ã€å‚ç…§è§£æ±ºãªã©ï¼‰
    fn sema(&self) -> &Semantic<'_, RootDatabase>
    
    // ğŸ“„ ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ID
    fn file_id(&self) -> FileId
}
```

### ğŸ¯ å®Ÿéš›ã®ä½¿ç”¨ä¾‹

#### useæ–‡æ¤œå‡ºã®ä¾‹
```rust
// 1ï¸âƒ£ ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã®useæ–‡ã‚’æ¢ã™
let use_item = ctx.find_node_at_offset::<ast::Use>()?;

// 2ï¸âƒ£ useæ–‡ã®è©³ç´°ã‚’åˆ†æ
let use_tree = use_item.use_tree()?;
let path = use_tree.path()?;

// 3ï¸âƒ£ useæ–‡ã®è¦ªè¦ç´ ã‚’ç¢ºèªï¼ˆé–¢æ•°å†… vs ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ï¼‰
let parent = use_item.syntax().parent()?;
```

#### çŠ¶æ³åˆ†æã®ä¾‹  
```rust
// ğŸ  ã©ã“ã«ã„ã‚‹ã‹ã‚’ç‰¹å®š
let container = use_item.syntax().ancestors()
    .find_map(|node| {
        match_ast! {
            match node {
                ast::Fn(func) => Some(Container::Function(func)),
                ast::Impl(impl_) => Some(Container::Impl(impl_)),
                ast::Module(module) => Some(Container::Module(module)),
                _ => None,
            }
        }
    });

enum Container {
    Function(ast::Fn),    // é–¢æ•°å†… â†’ ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã¸ç§»å‹•
    Impl(ast::Impl),      // implå†… â†’ implå¤–ã¸ç§»å‹•  
    Module(ast::Module),  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†… â†’ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¤–ã¸ç§»å‹•
}
```


### ğŸ”§ Assists ã®è©³ç´°è§£èª¬

### Assists ã®å½¹å‰²
`Assists` ã¯**åˆ©ç”¨å¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åé›†ã™ã‚‹å®¹å™¨**ã§ã™ã€‚å„ã‚¢ã‚·ã‚¹ãƒˆé–¢æ•°ãŒã€Œç§ã¯ã“ã‚“ãªã“ã¨ãŒã§ãã¾ã™ï¼ã€ã¨ç™»éŒ²ã™ã‚‹å ´æ‰€ã§ã™ã€‚

### ğŸ—ï¸ Assists ã®å†…éƒ¨æ§‹é€ 
```
ğŸ”§ Assists
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vec<Assist>                        â”‚ â† åˆ©ç”¨å¯èƒ½ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Assist {                        â”‚ â”‚
â”‚ â”‚   id: AssistId,                 â”‚ â”‚ â† è­˜åˆ¥å­("move_use_to_top")
â”‚ â”‚   label: String,                â”‚ â”‚ â† è¡¨ç¤ºå("Move use to top")
â”‚ â”‚   group: Option<GroupLabel>,    â”‚ â”‚ â† ã‚°ãƒ«ãƒ¼ãƒ—åŒ–æƒ…å ±
â”‚ â”‚   target: TextRange,           â”‚ â”‚ â† ãƒã‚¤ãƒ©ã‚¤ãƒˆç¯„å›²
â”‚ â”‚   source_change: SourceChange  â”‚ â”‚ â† å®Ÿéš›ã®å¤‰æ›´å†…å®¹
â”‚ â”‚ }                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ config: &AssistConfig               â”‚ â† ã‚¢ã‚·ã‚¹ãƒˆã®è¨­å®š
â”‚ resolve: AssistResolveStrategy      â”‚ â† è§£æ±ºæˆ¦ç•¥ï¼ˆå³åº§ or é…å»¶ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¬ acc.add() ã®å‹•ä½œè©³ç´°
```rust
// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™»éŒ²ã®è©³ç´°
acc.add(
    AssistId("move_use_to_top", AssistKind::Refactor),  // 1ï¸âƒ£ è­˜åˆ¥æƒ…å ±
    "Move use statement to top-level",                   // 2ï¸âƒ£ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘è¡¨ç¤º
    target_range,                                        // 3ï¸âƒ£ ãƒã‚¤ãƒ©ã‚¤ãƒˆç¯„å›²
    |builder| {                                         // 4ï¸âƒ£ å¤‰æ›´å‡¦ç†
        // ã“ã®æ™‚ç‚¹ã§å®Ÿéš›ã®ç·¨é›†ãŒè¨˜éŒ²ã•ã‚Œã‚‹
        builder.delete(old_range);
        builder.insert(new_position, new_text);
    },
)
```

#### å‡¦ç†ã®æµã‚Œ
```
ğŸ¬ acc.add() ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

1ï¸âƒ£ åŸºæœ¬æƒ…å ±è¨­å®š
   â”œâ”€ AssistId: å†…éƒ¨è­˜åˆ¥å­
   â”œâ”€ AssistKind: ã‚«ãƒ†ã‚´ãƒªï¼ˆRefactor, QuickFixç­‰ï¼‰
   â””â”€ Label: ã‚¨ãƒ‡ã‚£ã‚¿è¡¨ç¤ºç”¨æ–‡å­—åˆ—

2ï¸âƒ£ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š  
   â””â”€ target_range: ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ç¯„å›²

3ï¸âƒ£ å¤‰æ›´å‡¦ç†è¨˜éŒ²
   â”œâ”€ builder.delete() â†’ å‰Šé™¤æ“ä½œã‚’è¨˜éŒ²
   â”œâ”€ builder.insert() â†’ æŒ¿å…¥æ“ä½œã‚’è¨˜éŒ²
   â””â”€ SourceChange ã«å¤‰æ›ã—ã¦ä¿å­˜

4ï¸âƒ£ Assistsã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
   â””â”€ Vec<Assist>ã«æ–°ã—ã„Assistã‚’è¿½åŠ 
```

### å®Ÿéš›ã®æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
```rust
// useæ–‡ã‚’æ¤œå‡º
let use_item = ctx.find_node_at_offset::<ast::Use>()?;

// è¦ªã®é–¢æ•°ã‚’æ¤œå‡ºï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ãªã„ã“ã¨ã‚’ç¢ºèªï¼‰
let parent_fn = use_item.syntax().ancestors()
    .find_map(ast::Fn::cast)?;
```

## ğŸŒ ä¾å­˜é–¢ä¿‚ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ è©³ç´°

### ğŸ—ï¸ rust-analyzer ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
```
ğŸ›ï¸ rust-analyzer å…¨ä½“æ§‹é€ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ® ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆVSCode, Neovimç­‰ï¼‰                              â”‚
â”‚ â†•ï¸ LSP Protocol                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§  rust-analyzer ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¯ IDE Layer (crates/ide/)                             â”‚ â”‚
â”‚ â”‚ â”œâ”€ completion: è‡ªå‹•è£œå®Œ                                 â”‚ â”‚  
â”‚ â”‚ â”œâ”€ hover: ãƒ›ãƒãƒ¼æƒ…å ±                                    â”‚ â”‚
â”‚ â”‚ â”œâ”€ goto_definition: å®šç¾©ã‚¸ãƒ£ãƒ³ãƒ—                        â”‚ â”‚
â”‚ â”‚ â””â”€ assists: ã‚³ãƒ¼ãƒ‰å¤‰æ›ï¼ˆæˆ‘ã€…ã®ä½œæ¥­é ˜åŸŸï¼ï¼‰               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“Š Analysis Layer (crates/ide-db/)                     â”‚ â”‚
â”‚ â”‚ â”œâ”€ RootDatabase: å…¨ãƒ‡ãƒ¼ã‚¿ã®ä¸­å¤®ç®¡ç†                     â”‚ â”‚
â”‚ â”‚ â”œâ”€ imports/: importæ“ä½œã®æ ¸å¿ƒéƒ¨åˆ†                       â”‚ â”‚
â”‚ â”‚ â”œâ”€ search/: ã‚³ãƒ¼ãƒ‰æ¤œç´¢                                  â”‚ â”‚
â”‚ â”‚ â””â”€ symbols/: ã‚·ãƒ³ãƒœãƒ«ç®¡ç†                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸŒ³ Base Layer (crates/hir*, syntax/)                   â”‚ â”‚
â”‚ â”‚ â”œâ”€ syntax: æ§‹æ–‡è§£æï¼ˆASTï¼‰                              â”‚ â”‚
â”‚ â”‚ â”œâ”€ hir: é«˜ãƒ¬ãƒ™ãƒ«ä¸­é–“è¡¨ç¾                                â”‚ â”‚
â”‚ â”‚ â””â”€ parser: Rustã‚³ãƒ¼ãƒ‰ã®è§£æ                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ ide-assists ã®ä¾å­˜é–¢ä¿‚ãƒãƒƒãƒ—
```
ğŸ“ crates/ide-assists/ ã®ä¾å­˜é–¢ä¿‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ ide-assists (æˆ‘ã€…ã®ä½œæ¥­å ´æ‰€)                  â”‚
â”‚                                                 â”‚
â”‚ ğŸ“¥ ä¾å­˜ã—ã¦ã„ã‚‹å¤–éƒ¨ã‚¯ãƒ¬ãƒ¼ãƒˆ                      â”‚
â”‚ â”œâ”€ ğŸŒ³ syntax (ASTæ“ä½œ)                         â”‚
â”‚ â”‚  â”œâ”€ ast::Use, ast::Fnç­‰ã®ãƒãƒ¼ãƒ‰å‹             â”‚
â”‚ â”‚  â”œâ”€ SyntaxNode, SyntaxElement                â”‚
â”‚ â”‚  â””â”€ TextRange, TextSize                      â”‚
â”‚ â”‚                                              â”‚
â”‚ â”œâ”€ ğŸ“Š ide-db (è§£æãƒ»æ“ä½œãƒ©ã‚¤ãƒ–ãƒ©ãƒª)              â”‚
â”‚ â”‚  â”œâ”€ imports/: useæ–‡æ“ä½œã®æ ¸å¿ƒ                â”‚
â”‚ â”‚  â”‚  â”œâ”€ insert_use::insert_use               â”‚
â”‚ â”‚  â”‚  â”œâ”€ merge_imports::try_merge_imports     â”‚
â”‚ â”‚  â”‚  â””â”€ MergeBehavior, InsertUseConfig      â”‚
â”‚ â”‚  â”œâ”€ RootDatabase: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹             â”‚
â”‚ â”‚  â””â”€ search/: ã‚³ãƒ¼ãƒ‰æ¤œç´¢æ©Ÿèƒ½                  â”‚
â”‚ â”‚                                              â”‚
â”‚ â”œâ”€ ğŸ§  hir (æ„å‘³è§£æ)                           â”‚
â”‚ â”‚  â”œâ”€ Module, Functionç­‰ã®æ„å‘³æƒ…å ±             â”‚
â”‚ â”‚  â””â”€ å‹æƒ…å ±ã€ã‚¹ã‚³ãƒ¼ãƒ—è§£æ                      â”‚
â”‚ â”‚                                              â”‚
â”‚ â””â”€ ğŸ”§ stdx (ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£)                     â”‚
â”‚    â””â”€ å…±é€šçš„ãªãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°                      â”‚
â”‚                                                 â”‚
â”‚ ğŸ“¤ æä¾›ã—ã¦ã„ã‚‹æ©Ÿèƒ½                             â”‚
â”‚ â””â”€ Assists: ã‚¨ãƒ‡ã‚£ã‚¿å‘ã‘ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ move_use_to_top å®Ÿè£…ã§ä½¿ã†ä¾å­˜é–¢ä¿‚
```
ğŸ¯ move_use_to_top ã®å®Ÿè£…ä¾å­˜é–¢ä¿‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ move_use_to_top(acc, ctx)                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ä½¿ç”¨ã™ã‚‹ä¸»è¦ãªå‹ã¨ãƒ¡ã‚½ãƒƒãƒ‰                   â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ ğŸ“ AssistContext ã‹ã‚‰                       â”‚ â”‚
â”‚ â”‚ â”œâ”€ find_node_at_offset::<ast::Use>()       â”‚ â”‚
â”‚ â”‚ â”œâ”€ source_file()                           â”‚ â”‚
â”‚ â”‚ â””â”€ sema() // æ„å‘³è§£æã‚¢ã‚¯ã‚»ã‚¹               â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ ğŸŒ³ syntax ã‚¯ãƒ¬ãƒ¼ãƒˆã‹ã‚‰                      â”‚ â”‚
â”‚ â”‚ â”œâ”€ ast::Use, ast::Fn                       â”‚ â”‚
â”‚ â”‚ â”œâ”€ SyntaxNode::ancestors()                 â”‚ â”‚
â”‚ â”‚ â”œâ”€ TextRange                               â”‚ â”‚
â”‚ â”‚ â””â”€ match_ast! ãƒã‚¯ãƒ­                        â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ ğŸ“Š ide-db::imports ã‹ã‚‰                    â”‚ â”‚
â”‚ â”‚ â”œâ”€ insert_use::insert_use()                â”‚ â”‚
â”‚ â”‚ â”œâ”€ InsertUseConfig                         â”‚ â”‚
â”‚ â”‚ â””â”€ MergeBehavior                           â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ ğŸ”§ Assists ã¸ç™»éŒ²                          â”‚ â”‚  
â”‚ â”‚ â””â”€ acc.add() ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”„ å®Ÿè¡Œæ™‚ã®æƒ…å ±ãƒ•ãƒ­ãƒ¼
```
ğŸ”„ move_use_to_top å®Ÿè¡Œæ™‚ã®æƒ…å ±ãƒ•ãƒ­ãƒ¼

1ï¸âƒ£ ã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ã®è¦æ±‚
   ğŸ® VSCodeã€Œã‚«ãƒ¼ã‚½ãƒ«ä½ç½®: line 5, col 10ã€
   â†“ LSP Protocol
   ğŸ§  rust-analyzerã€Œã‚¢ã‚·ã‚¹ãƒˆç¢ºèªé–‹å§‹ã€

2ï¸âƒ£ AssistContext æ§‹ç¯‰
   ğŸ“‹ AssistContext {
   â”œâ”€ offset: 95 (æ–‡å­—ä½ç½®)
   â”œâ”€ source_file: æ§‹æ–‡æœ¨
   â”œâ”€ db: RootDatabaseå‚ç…§
   â””â”€ config: ã‚¢ã‚·ã‚¹ãƒˆè¨­å®š
   }

3ï¸âƒ£ ASTè§£æ
   ğŸŒ³ syntax::ast::Use â† find_node_at_offset()
   â”œâ”€ use_tree: "std::collections::HashMap"
   â”œâ”€ parent: ast::Fn (é–¢æ•°å†…useæ–‡ã¨åˆ¤æ˜)
   â””â”€ ancestors: [Use, Fn, SourceFile]

4ï¸âƒ£ å¤‰æ›å‡¦ç†è¨ˆç”»
   ğŸ“Š ide-db::imports â† æ“ä½œæ–¹æ³•ã‚’æ±ºå®š
   â”œâ”€ å‰Šé™¤: å…ƒã®useæ–‡ä½ç½®
   â”œâ”€ æŒ¿å…¥: ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ä»˜è¿‘
   â””â”€ ãƒãƒ¼ã‚¸: æ—¢å­˜useæ–‡ã¨ã®çµ±åˆ

5ï¸âƒ£ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç™»éŒ²
   ğŸ”§ Assists::add() â† ã‚¨ãƒ‡ã‚£ã‚¿å‘ã‘æƒ…å ±
   â”œâ”€ AssistId: "move_use_to_top"
   â”œâ”€ Label: "Move use statement to top-level"  
   â”œâ”€ target: useæ–‡ã®ç¯„å›²
   â””â”€ builder: å®Ÿéš›ã®ç·¨é›†å‡¦ç†

6ï¸âƒ£ ã‚¨ãƒ‡ã‚£ã‚¿ã¸è¿”å´
   ğŸ® VSCodeã€ŒğŸ’¡ Move use statement to top-levelã€
```

## ğŸ”„ useæ–‡ã®æ“ä½œãƒ¡ã‚½ãƒƒãƒ‰

### MergeBehaviorï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–æˆ¦ç•¥ï¼‰
```rust
pub enum MergeBehavior {
    Crate,   // ã‚¯ãƒ¬ãƒ¼ãƒˆæ¯ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    Module,  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¯ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–  
    One,     // 1ã¤ã«ã¾ã¨ã‚ã‚‹
}
```

### InsertUseConfigï¼ˆæŒ¿å…¥è¨­å®šï¼‰
```rust
pub struct InsertUseConfig {
    pub merge: Option<MergeBehavior>,  // ãƒãƒ¼ã‚¸æˆ¦ç•¥
    pub prefix_kind: PrefixKind,       // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹å½¢å¼
    pub group: bool,                   // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ã‹
}
```

## ğŸ›  å®Ÿè£…ã§å‚è€ƒã«ãªã‚‹ã‚³ãƒ¼ãƒ‰

### 1. `/crates/ide-assists/src/handlers/extract_module.rs`
**å‚è€ƒãƒã‚¤ãƒ³ãƒˆ**: è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®å¤‰æ›å‡¦ç†
```rust
acc.add(
    AssistId("extract_module", AssistKind::RefactorExtract),
    "Extract Module",
    target.text_range(),
    |builder| {
        // è¤‡æ•°ã®ç·¨é›†æ“ä½œ
        builder.edit_file(file_id);
        builder.delete(range);
        builder.insert(offset, text);
    },
)
```

### 2. Textç·¨é›†ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
```rust
// ğŸ—‘ å‰Šé™¤
builder.delete(use_item.syntax().text_range());

// â• æŒ¿å…¥  
builder.insert(offset, new_text);

// ğŸ“ è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†
builder.edit_file(file_id);
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

### åŸºæœ¬ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹
```rust
#[cfg(test)]
mod tests {
    use crate::tests::{check_assist, check_assist_not_applicable};
    
    #[test]
    fn test_basic_move() {
        check_assist(
            move_use_to_top,
            r#"
fn test() {
    use std::collections::HashMap$0;  // $0 = ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®
    let map = HashMap::new();
}
"#,
            r#"
use std::collections::HashMap;

fn test() {
    let map = HashMap::new();
}
"#,
        );
    }
    
    #[test]
    fn test_not_applicable_for_top_level() {
        check_assist_not_applicable(
            move_use_to_top,
            r#"
use std::collections::HashMap$0;  // ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ« = é©ç”¨ä¸å¯
"#,
        );
    }
}
```

## ğŸ“ å®Ÿè£…ã®æµã‚Œ

```
1. ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
   ğŸ“„ /handlers/move_use_to_top.rs

2. åŸºæœ¬æ§‹é€ å®Ÿè£…
   ğŸ¯ ã‚«ãƒ¼ã‚½ãƒ«æ¤œå‡º â†’ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¢ºèª â†’ å¤‰æ›å‡¦ç†

3. ãƒ†ã‚¹ãƒˆä½œæˆ
   ğŸ§ª æ­£å¸¸ã‚±ãƒ¼ã‚¹ + ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

4. ç™»éŒ²
   ğŸ“‹ lib.rs ã«è¿½åŠ 

5. å‹•ä½œç¢ºèª
   ğŸš€ cargo test ã§ç¢ºèª
```