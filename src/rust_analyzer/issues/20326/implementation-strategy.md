# ğŸš€ å®Ÿè£…æ–¹é‡

issue #20326ã‚’**æ®µéšçš„ã«**ã€**ç¢ºå®Ÿã«**å®Ÿè£…ã™ã‚‹ãŸã‚ã®æˆ¦ç•¥ã‚’èª¬æ˜ã—ã¾ã™ã€‚åˆå¿ƒè€…ã§ã‚‚è¿·ã‚ãªã„ã‚ˆã†ã€ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã§é€²ã‚ã¾ã™ã€‚

## ğŸ¯ å…¨ä½“ã®é€²ã‚æ–¹

```
ğŸ”¥ Phase 1: ã¨ã‚Šã‚ãˆãšå‹•ãçŠ¶æ…‹ã‚’ä½œã‚‹
    â†“
âš¡ Phase 2: åŸºæœ¬çš„ãªç§»å‹•æ©Ÿèƒ½ã‚’å®Ÿè£…
    â†“  
ğŸ§© Phase 3: æ—¢å­˜ã®useæ–‡ã¨ã®çµ±åˆ
    â†“
ğŸ›¡ Phase 4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§å®Œç’§ã«
```

## ğŸ“‹ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

### Phase 1: åŸºæœ¬æ§‹é€ ã®æ§‹ç¯‰ ğŸ—
```
ğŸ¯ Goal: æœ€å°é™ã®å‹•ä½œã™ã‚‹å®Ÿè£…ã‚’ä½œã‚‹

ğŸ“ Tasks:
1. ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
2. åŸºæœ¬çš„ãªã‚«ãƒ¼ã‚½ãƒ«æ¤œå‡ºã®å®Ÿè£…
3. ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä½œæˆ
4. lib.rs ã¸ã®ç™»éŒ²

â± æœŸé–“: 1-2æ—¥
âœ… æˆåŠŸåŸºæº–: ã‚«ãƒ¼ã‚½ãƒ«ãŒ use æ–‡ã«ã‚ã‚‹ã¨ãã‚¢ã‚·ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### Phase 2: ç§»å‹•æ©Ÿèƒ½ã®å®Ÿè£… ğŸ”„
```
ğŸ¯ Goal: use æ–‡ã®ç§»å‹•æ©Ÿèƒ½ã‚’å®Ÿè£…

ğŸ“ Tasks:
1. use æ–‡ã®å‰Šé™¤å‡¦ç†
2. ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã¸ã®æŒ¿å…¥å‡¦ç†
3. åŸºæœ¬çš„ãªç§»å‹•ãƒ†ã‚¹ãƒˆã®ä½œæˆ

â± æœŸé–“: 2-3æ—¥
âœ… æˆåŠŸåŸºæº–: å˜ç´”ãª use æ–‡ãŒãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã«ç§»å‹•ã•ã‚Œã‚‹
```

### Phase 3: çµ±åˆãƒ»ã‚°ãƒ«ãƒ¼ãƒ—åŒ–æ©Ÿèƒ½ ğŸ§©
```
ğŸ¯ Goal: æ—¢å­˜ã® use æ–‡ã¨ã®çµ±åˆ

ğŸ“ Tasks:
1. æ—¢å­˜ use æ–‡ã®æ¤œå‡º
2. MergeBehavior ã‚’ä½¿ã£ãŸçµ±åˆ
3. ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®ãƒ†ã‚¹ãƒˆ

â± æœŸé–“: 2-3æ—¥  
âœ… æˆåŠŸåŸºæº–: æ—¢å­˜ã® use æ–‡ã¨é©åˆ‡ã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹
```

### Phase 4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ ğŸ›¡
```
ğŸ¯ Goal: å …ç‰¢æ€§ã®å‘ä¸Š

ğŸ“ Tasks:
1. ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ« use æ–‡ã§ã®ç„¡åŠ¹åŒ–
2. è¤‡é›‘ãªã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒã‚¹ãƒˆé–¢æ•°ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ç­‰ï¼‰
3. ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®å……å®Ÿ

â± æœŸé–“: 1-2æ—¥
âœ… æˆåŠŸåŸºæº–: å…¨ã¦ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã§é©åˆ‡ã«å‹•ä½œ
```

## ğŸ›  è©³ç´°å®Ÿè£…è¨ˆç”»

### 1. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
```
ğŸ“ /crates/ide-assists/src/handlers/
â”œâ”€â”€ move_use_to_top.rs        ğŸ‘ˆ ãƒ¡ã‚¤ãƒ³å®Ÿè£…
â””â”€â”€ tests/
    â””â”€â”€ move_use_to_top.rs    ğŸ‘ˆ ãƒ†ã‚¹ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
```

### 2. ã‚³ã‚¢å®Ÿè£…ã®è¨­è¨ˆ

#### ğŸ¯ main function signature
```rust
pub(crate) fn move_use_to_top(acc: &mut Assists, ctx: &AssistContext) -> Option<()>
```

#### ğŸ” detection logic
```rust
// Step 1: use æ–‡ã®æ¤œå‡º
let use_item = ctx.find_node_at_offset::<ast::Use>()?;

// Step 2: é–¢æ•°å†…ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã§ãªã„ï¼‰
let parent_fn = use_item.syntax().ancestors()
    .find_map(ast::Fn::cast)?;

// Step 3: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®å ´åˆã‚‚è€ƒæ…®
let in_module = use_item.syntax().ancestors()
    .any(|node| ast::Module::can_cast(node.kind()));
```

#### ğŸ”„ transformation logic
```rust
acc.add(
    AssistId("move_use_to_top", AssistKind::Refactor),
    "Move use statement to top-level",
    use_item.syntax().text_range(),
    |builder| {
        // 1. ç¾åœ¨ä½ç½®ã‹ã‚‰å‰Šé™¤
        builder.delete(use_item.syntax().text_range());
        
        // 2. ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã«æŒ¿å…¥ï¼ˆide-db ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
        let source_file = ctx.sema.parse(ctx.file_id());
        insert_use(&source_file, use_item.clone(), &ctx.config.insert_use);
    },
)
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### Priority 1: åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
```rust
#[test] fn test_move_simple_use_from_function()
#[test] fn test_not_applicable_for_top_level_use()
#[test] fn test_cursor_not_on_use_statement()
```

### Priority 2: çµ±åˆãƒ†ã‚¹ãƒˆ  
```rust
#[test] fn test_merge_with_existing_uses()
#[test] fn test_group_with_same_crate_imports()
#[test] fn test_preserve_use_statement_formatting()
```

### Priority 3: ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
```rust
#[test] fn test_nested_function_use()
#[test] fn test_module_inner_function_use()
#[test] fn test_multiple_use_statements_in_function()
```

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

### âœ… æœ€å°é™æˆåŠŸï¼ˆMVPï¼‰
- [ ] ã‚«ãƒ¼ã‚½ãƒ«ãŒé–¢æ•°å†…ã® use æ–‡ã«ã‚ã‚‹ã¨ãã‚¢ã‚·ã‚¹ãƒˆãŒææ¡ˆã•ã‚Œã‚‹
- [ ] use æ–‡ãŒãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã«ç§»å‹•ã•ã‚Œã‚‹
- [ ] å…ƒã® use æ–‡ãŒå‰Šé™¤ã•ã‚Œã‚‹

### âœ… å®Œå…¨æˆåŠŸï¼ˆFull Featureï¼‰
- [ ] æ—¢å­˜ã® use æ–‡ã¨é©åˆ‡ã«ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹
- [ ] ã‚°ãƒ«ãƒ¼ãƒ—åŒ–æˆ¦ç•¥ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒˆåˆ¥ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ï¼‰ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã® use æ–‡ã§ã¯ææ¡ˆã•ã‚Œãªã„
- [ ] è¤‡é›‘ãªãƒã‚¹ãƒˆæ§‹é€ ã§ã‚‚å‹•ä½œã™ã‚‹

## ğŸš§ å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹

### âš ï¸ è½ã¨ã—ç©´
1. **Text Range ã®è¨ˆç®—**: use æ–‡ã®æ­£ç¢ºãªç¯„å›²ã‚’å–å¾—
2. **Insert Position**: ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­ã®é©åˆ‡ãªä½ç½®ã‚’ç‰¹å®š
3. **Merge Behavior**: æ—¢å­˜ã®è¨­å®šã«å¾“ã£ãŸãƒãƒ¼ã‚¸å‡¦ç†
4. **Syntax Tree**: AST ã®å¤‰æ›´æ™‚ã®æ•´åˆæ€§

### ğŸ’¡ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
1. **å°ã•ãå§‹ã‚ã‚‹**: æœ€å°é™ã®æ©Ÿèƒ½ã‹ã‚‰å®Ÿè£…
2. **ãƒ†ã‚¹ãƒˆé§†å‹•**: å®Ÿè£…å‰ã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ˜ç¢ºåŒ–
3. **æ—¢å­˜ã‚³ãƒ¼ãƒ‰æ´»ç”¨**: ide-db ã®æ©Ÿèƒ½ã‚’æœ€å¤§é™æ´»ç”¨
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©ç”¨ä¸å¯èƒ½ãªã‚±ãƒ¼ã‚¹ã‚’æ˜ç¢ºåŒ–

## ğŸ“š å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹

### äº‹å‰å­¦ç¿’ãŒå¿…è¦ãªæ¦‚å¿µ
1. **AST (Abstract Syntax Tree)**: Rust ã‚³ãƒ¼ãƒ‰ã®æ§‹æ–‡æœ¨
2. **LSP Assists**: Language Server Protocol ã®ã‚¢ã‚·ã‚¹ãƒˆæ©Ÿèƒ½
3. **Text Editing**: ã‚¨ãƒ‡ã‚£ã‚¿ã§ã®ãƒ†ã‚­ã‚¹ãƒˆæ“ä½œ
4. **Import Merging**: use æ–‡ã®ãƒãƒ¼ã‚¸æˆ¦ç•¥

### å‚è€ƒã«ã™ã¹ãæ—¢å­˜ã‚³ãƒ¼ãƒ‰
1. `auto_import.rs` - use æ–‡ã®æŒ¿å…¥å‡¦ç†
2. `extract_module.rs` - è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®å¤‰æ›å‡¦ç†
3. `merge_imports.rs` - use æ–‡ã®ãƒãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯