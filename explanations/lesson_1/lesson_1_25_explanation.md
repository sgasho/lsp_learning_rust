
# Lesson 1-25: 名前をまとめて変えよう！ (LSPリネーム)

LSPのコードフォーマット機能ができるようになりましたね。素晴らしいです！

次に、言語サーバーの非常に強力なリファクタリング機能の一つである「**リネーム (Rename)**」について学びます。エディタがシンボルの名前変更を要求したときに、言語サーバーがどのようにコード全体でその変更を適用するのか、その形式と作成方法を学びます。

## リネーム (Rename) とは？

リネーム機能は、コード中の変数名や関数名などを変更すると、そのシンボルが使われているすべての場所（定義箇所、参照箇所など）の名前を自動的に変更してくれる機能です。これにより、手動での変更ミスを防ぎ、大規模なリファクタリングを安全に行うことができます。

エディタは、ユーザーがリネームを要求すると、言語サーバーに `textDocument/rename` リクエストを送ります。サーバーはこれに対して、名前変更を適用するための `WorkspaceEdit` オブジェクトを返します。

## `lsp-types::WorkspaceEdit` の構造

`WorkspaceEdit` の構造は、Lesson 1-23で学んだコードアクションの `edit` フィールドで使ったものと同じです。`changes` と `document_changes` を持ちます。

*   `changes`: `HashMap<Url, Vec<TextEdit>>` の形式で、ファイルごとの `TextEdit` のリストを格納します。
*   `document_changes`: オプションのフィールドで、より複雑な変更（ファイルの作成、削除、名前変更など）を表現します。

今回のレッスンでは、`changes` フィールドを使って、コードの変更を提案します。

## コードの単語を特定し、すべての出現箇所を置き換える

ホバー機能や定義へ移動機能、参照の検索機能と同様に、まずカーソル位置にある「単語」を特定する必要があります。Lesson 1-19で実装した単語抽出ロジックを再利用できます。

今回のレッスンでは、シンプルに「`my_variable`」という単語がカーソル位置にあれば、その単語がコード全体で出現する場所をすべて見つけ出し、新しい名前に置き換える `TextEdit` を作成します。見つかったすべての場所を `TextEdit` オブジェクトとしてリストにまとめ、`WorkspaceEdit` に設定します。

**ヒント:**
*   Lesson 1-21の `find_references` 関数で使ったロジックを参考に、`"my_variable"` のすべての出現箇所を `Location` として取得します。
*   取得した各 `Location` の `range` と `new_name` を使って `TextEdit` を作成します。
*   すべての `TextEdit` を `Vec<TextEdit>` にまとめ、`HashMap<Url, Vec<TextEdit>>` に挿入し、`WorkspaceEdit` を構築します。

## やってみよう！

あなたの今回のミッションは、`prepare_rename` 関数を完成させることです。

1.  `document_store` から `file_uri` に対応するファイルの内容を取得します。見つからなければ `None` を返します。
2.  `position.line` と `position.character` を使って、カーソル位置にある単語を特定します。Lesson 1-19で使った単語抽出ロジックを参考にしてください。
3.  特定した単語が `"my_variable"` であれば、その単語が `file_content` 全体で出現するすべての場所を検索します。
4.  見つかった各出現箇所に対して `TextEdit` オブジェクトを作成し、`new_name` で置き換えるように設定します。
5.  すべての `TextEdit` を `Vec<TextEdit>` にまとめ、`file_uri` をキーとする `HashMap<Url, Vec<TextEdit>>` に挿入し、`WorkspaceEdit` を構築して `Some(WorkspaceEdit)` として返します。
6.  それ以外の単語、または単語が特定できない場合は `None` を返します。

`src/lessons/lesson_1_25.rs` を開いて、挑戦しましょう。

`cargo test` でテストがすべて緑色になったらクリアです！
