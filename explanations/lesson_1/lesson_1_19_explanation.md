
# Lesson 1-19: コードにマウスを合わせるとヒントが出るようにしよう！ (LSPホバー)

LSPのファイル管理ができるようになりましたね。素晴らしいです！

次に、エディタが特定のシンボルにマウスカーソルを合わせたときに、言語サーバーがどのようにそのシンボルに関する情報（型、ドキュメントなど）を返すのか、その形式と作成方法を学びます。これが「**ホバー (Hover)**」機能です。

## ホバー (Hover) とは？

ホバー機能は、開発者がコード中の変数名や関数名などにマウスカーソルを合わせると、そのシンボルに関する詳細な情報がポップアップ表示される機能です。これにより、コードの理解を深めたり、ドキュメントを参照したりする手間が省けます。

エディタは、ユーザーがマウスカーソルを移動するたびに、言語サーバーに `textDocument/hover` リクエストを送ります。サーバーはこれに対して、ホバー情報（`Hover` オブジェクト）を返します。

## `lsp-types::Hover` の構造

LSPのホバー情報は `lsp_types::Hover` という構造体で表現されます。主なフィールドは以下の通りです。

*   `contents`: ホバーとして表示される内容。`MarkupContent` または `Vec<MarkedString>` を使います。今回は `MarkupContent` を使います。
    *   `MarkupContent`: `kind` (表示形式、`Markdown` または `PlainText`) と `value` (表示する文字列) を持ちます。
*   `range`: オプションのフィールドで、ホバー情報が関連するコードの範囲を示します。この範囲内のどこにカーソルを合わせても同じホバー情報が表示されます。

## コードの単語を特定する

ホバー機能を実現するには、まずカーソル位置にある「単語」を特定する必要があります。これは少し複雑ですが、今回はシンプルに考えましょう。

1.  `document_store` から `file_uri` に対応するファイルの内容（`String`）を取得します。
2.  ファイルの内容を改行で分割し、`position.line` に対応する行を取得します。
3.  その行から、`position.character` に対応する文字の前後にある単語を特定します。
    *   **ヒント**: `char_indices()` を使って文字のインデックスを取得し、`is_alphanumeric()` や `is_whitespace()` などを使って単語の境界を見つけることができます。または、正規表現を使う方法もありますが、今回はシンプルに、カーソル位置の文字が属する単語全体を取得することを考えます。
    *   **より簡単な方法**: 今回のレッスンでは、カーソル位置がキーワードの先頭にあると仮定し、その位置から始まる単語を単純に切り出すだけでもテストはパスします。例えば、`line.get(position.character as usize..)` のようにスライスし、最初の空白や改行までを単語とみなす、といった方法です。

## やってみよう！

あなたの今回のミッションは、`get_hover_info` 関数を完成させることです。

1.  `document_store` から `file_uri` に対応するファイルの内容を取得します。見つからなければ `None` を返します。
2.  `position.line` に対応する行を取得します。行が存在しなければ `None` を返します。
3.  その行から、`position.character` に対応する単語を特定します。今回は、カーソル位置から始まる単語を切り出すシンプルな方法でOKです。
4.  特定した単語が以下のいずれかであれば、対応する `Hover` オブジェクトを返します。
    *   `"fn"`: `"Keyword: Function definition"`
    *   `"let"`: `"Keyword: Variable declaration"`
    *   `"struct"`: `"Keyword: Structure definition"`
5.  それ以外の単語、または単語が特定できない場合は `None` を返します。

`src/lessons/lesson_1_19.rs` を開いて、挑戦しましょう。

`cargo test` でテストがすべて緑色になったらクリアです！
