# Lesson 1-24: コードをきれいに整えよう！ (LSPコードフォーマット)

LSPのコードアクション機能ができるようになりましたね。素晴らしいです！

次に、言語サーバーの非常に便利な機能の一つである「**コードフォーマット (Code Formatting)**」について学びます。エディタがドキュメントのフォーマットを要求したときに、言語サーバーがどのように整形されたテキストを返すのか、その形式と作成方法を学びます。

## コードフォーマット (Code Formatting) とは？

コードフォーマットは、コードの見た目を自動的に整える機能です。インデントの修正、空白の調整、改行の追加・削除などを行い、コードを読みやすく、一貫性のあるスタイルにします。これにより、チーム開発でのコードスタイルの統一が容易になり、コードレビューの効率も向上します。

エディタは、ユーザーがドキュメントのフォーマットを要求すると、言語サーバーに `textDocument/formatting` リクエスト（または `textDocument/rangeFormatting`）を送ります。サーバーはこれに対して、コードを整形するための `TextEdit` オブジェクトのリストを返します。

## `lsp-types::TextEdit` の構造

`TextEdit` の構造は、Lesson 1-23で学んだコードアクションの `edit` フィールドで使ったものと同じです。`range` と `new_text` を持ちます。

*   `range`: 変更するコードの範囲。
*   `new_text`: 置き換える新しいテキスト。

今回のレッスンでは、各行の先頭と末尾にある不要な空白を削除する（トリムする）という非常にシンプルなフォーマットを行います。つまり、各行に対して、その行全体を範囲とする `TextEdit` を作成し、`new_text` にはトリムされた行の文字列を設定します。

## コードの分析と `TextEdit` の生成

1.  `document_store` から `file_uri` に対応するファイルの内容（`String`）を取得します。
2.  ファイルの内容を1行ずつ処理し、行番号も取得します。
3.  各行に対して、`trim()` メソッドを使って空白を削除した文字列を取得します。
4.  もし元の行とトリムされた行が異なる（つまり、空白が削除された）場合、その行全体を対象とする `TextEdit` を作成します。
    *   `range`: `Range::new(Position::new(行番号, 0), Position::new(行番号, 元の行の長さ))`。
    *   `new_text`: トリムされた行の文字列。
5.  作成した `TextEdit` を `Vec<TextEdit>` に追加して返します。

**ヒント:**
*   `line.len()` はバイト数を返します。`Position` の `character` は文字数を表すので、マルチバイト文字を考慮する場合は `line.chars().count()` を使うとより正確ですが、今回のレッスンではASCII文字のみを想定しているため `line.len()` でも問題ありません。

## やってみよう！

あなたの今回のミッションは、`format_document` 関数を完成させることです。

1.  `document_store` から `file_uri` に対応するファイルの内容を取得します。見つからなければ空の `Vec<TextEdit>` を返します。
2.  `file_content` を1行ずつ処理し、行番号も取得します。
3.  各行の先頭と末尾の空白をトリムした文字列を取得します。
4.  もし元の行とトリムされた行が異なる場合、その行全体を対象とする `TextEdit` を作成し、`Vec<TextEdit>` に追加します。
5.  見つかったすべての `TextEdit` を `Vec<TextEdit>` として返します。

`src/lessons/lesson_1_24.rs` を開いて、挑戦しましょう。

`cargo test` でテストがすべて緑色になったらクリアです！